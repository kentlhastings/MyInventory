<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auto Trader Dashboard</title>
    <link rel="stylesheet" href="https://cdn3.devexpress.com/jslib/23.1.3/css/dx.dark.css">
    <link rel="icon" href="data:,">
    <style>
        body {
            background-color: #121212;
            color: #e0e0e0;
            padding: 20px;
            font-family: Arial, sans-serif;
        }

        .section {
            margin-bottom: 20px;
            border: 1px solid #4e4e4e;
            border-radius: 5px;
            padding: 10px;
            background-color: #1e1e1e;
        }

        .section-header {
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
        }

        .button {
            background-color: #805ad5;
            color: white;
            font-weight: bold;
            padding: 5px 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .button:hover {
            background-color: #6b46c1;
        }

        .dx-datagrid-headers, .dx-datagrid-rowsview {
            background-color: #2c2c2c !important;
        }
    </style>
</head>
<body>

    <div class="section">
        <div class="section-header" onclick="toggleSection('investmentDetails')">
            <span>Investment Account</span><span id="toggleIcon1">−</span>
        </div>
        <div id="investmentDetails">
            <h3>Account Details</h3>
            <h3>Trade Details</h3>
        </div>
    </div>

    <div class="section">
        <div class="section-header" onclick="toggleSection('scannerSection')">
            <span>Stock Scanner</span><span id="toggleIcon2">−</span>
        </div>
        <div id="scannerSection">
            <div class="section">
                <h3>Scan Details</h3>
                <p>(Scan parameters and filters will appear here in the future.)</p>
            </div>
            <button class="button" onclick="fetchScanResults()">Scan</button>
            <div id="loading" style="margin-top:10px; display:none;">Scanning...</div>
            <div id="gridContainer" style="margin-top: 20px;"></div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn3.devexpress.com/jslib/23.1.3/js/dx.all.js"></script>
    <script>
        const _debug = false;
        const _scanRoute = "/api/scan/scan";
        const _shutdownRoute = "/api/application";

        const dummyData = [
            {
                Ticker: "BMGL",
                Price: 4.52,
                PercentChange: 12.34,
                RelativeVolume: 6.78,
                Float: 15.2,
                Bid: 4.5,
                Ask: 4.55
            },
            {
                Ticker: "HCVI",
                Price: 3.21,
                PercentChange: 15.67,
                RelativeVolume: 5.43,
                Float: 18.7,
                Bid: 3.19,
                Ask: 3.25
            }
        ];

        function toggleSection(sectionId) {
            const el = $('#' + sectionId);
            const icon = sectionId === 'investmentDetails' ? '#toggleIcon1' : '#toggleIcon2';
            if (el.is(':visible')) {
                el.slideUp();
                $(icon).text('+');
            } else {
                el.slideDown();
                $(icon).text('−');
            }
        }

        function fetchScanResults() {
            $('#loading').show();
            let data;
            if (_debug) {
                data = dummyData;
                renderGrid(data);
                $('#loading').hide();
            } else {
                $.getJSON(_scanRoute, function (res) {
                    renderGrid(res);
                }).fail(function () {
                    console.error('Failed to fetch scan results');
                }).always(function () {
                    $('#loading').hide();
                });
            }
        }

        function renderGrid(data) {
            data.forEach(stock => {
                stock.Spread = (stock.Ask - stock.Bid).toFixed(2);
                stock.SpreadStyle = (stock.Ask - stock.Bid) / stock.Price <= 0.005 ? 'green' : 'red';
            });

            $("#gridContainer").dxDataGrid({
                dataSource: data,
                keyExpr: "Ticker",
                showBorders: true,
                onCellPrepared: function (e) {
                    if (e.rowType !== "header") return;
                    if (e.column.dataField === "Ticker") e.cellElement.attr("title", "The stock\'s ticker symbol.");
                    else if (e.column.dataField === "Price") e.cellElement.attr("title", "Current trading price.");
                    else if (e.column.dataField === "PercentChange") e.cellElement.attr("title", "Percent change in price since previous close.");
                    else if (e.column.dataField === "RelativeVolume") e.cellElement.attr("title", "Current volume compared to average volume.");
                    else if (e.column.dataField === "Float") e.cellElement.attr("title", "Total public shares available for trading.");
                    else if (e.column.dataField === "Bid") e.cellElement.attr("title", "Highest price a buyer is willing to pay.");
                    else if (e.column.dataField === "Ask") e.cellElement.attr("title", "Lowest price a seller is willing to accept.");
                    else if (e.column.dataField === "Spread") e.cellElement.attr("title", "Difference between Ask and Bid prices.");
                },
                columns: [
                    {
                        dataField: "Ticker",
                        caption: "Ticker",
                        width: 90,
                    },
                    {
                        dataField: "Price",
                        caption: "Price",
                        format: { type: "fixedPoint", precision: 2 },
                    },
                    {
                        dataField: "PercentChange",
                        caption: "% Change",
                        format: { type: "percent", precision: 2 },
                    },
                    {
                        dataField: "RelativeVolume",
                        caption: "Rel Vol",
                        format: { type: "fixedPoint", precision: 2 },
                    },
                    {
                        dataField: "Float",
                        caption: "Float (M)",
                        format: { type: "fixedPoint", precision: 2 },
                    },
                    {
                        dataField: "Bid",
                        caption: "Bid",
                        format: { type: "fixedPoint", precision: 2 },
                    },
                    {
                        dataField: "Ask",
                        caption: "Ask",
                        format: { type: "fixedPoint", precision: 2 },
                    },
                    {
                        dataField: "Spread",
                        caption: "Spread",
                        cellTemplate: function (container, options) {
                            const spreadColor = options.data.SpreadStyle === 'green' ? 'green' : 'red';
                            $("<div>").text("$" + options.value).css({ color: spreadColor, fontWeight: 'bold' }).appendTo(container);
                        },
                    },
                    {
                        caption: "Action",
                        cellTemplate: function (container, options) {
                            $("<div>")
                                .css({
                                    overflow: "visible",
                                    whiteSpace: "normal",
                                    textOverflow: "unset",
                                    display: "flex",
                                    justifyContent: "center"
                                })
                                .append(
                                    $("<button>")
                                        .addClass("button")
                                        .text("Buy Max")
                                        .on("click", function () {
                                            alert("Buy " + options.data.Ticker);
                                        })
                                )
                                .appendTo(container);
                        }
                    }
                ]
            });
        }

        $(document).ready(function () {
            fetchScanResults();
            setInterval(fetchScanResults, 10000);
        });
    </script>
</body>
</html>