<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>My Inventory</title>
    <link rel="stylesheet" href="https://cdn3.devexpress.com/jslib/23.2.5/css/dx.dark.compact.css" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn3.devexpress.com/jslib/23.2.5/js/dx.all.js"></script>
    <style>
        body {
            background: #2d2d2d;
            color: #f0f0f0;
            font-family: Segoe UI, sans-serif;
        }

        #dataset-selector {
            max-width: 260px
        }

        #selector-container {
            display: flex;
        }

        #dataset-selector {
            margin-right: 10px;
        }

        #add-collection {
            margin-right: 10px;
        }

        #edit-collection {
            margin-right: 10px;
        }

        #remove-collection {
        }
    </style>
</head>
<body>
    <div style="padding:20px">
        <div id="selector-container">
            <div id="dataset-selector"></div>
            <div id="add-collection"></div>
            <div id="edit-collection"></div>
            <div id="remove-collection"></div>
        </div>
        <div id="inventory-grid"></div>
        <div id="new-collection-popup"></div>
        <div id="edit-collection-popup"></div>
    </div>

    <script>
        const apiBase = 'http://localhost:5000/api';
        const gridElement = $('#inventory-grid');
        const selectorElement = $('#dataset-selector');
        const newCollectionPopupElement = $('#new-collection-popup');
        const editCollectionPopupElement = $('#edit-collection-popup');

        var currentCollectionId = "";
        var newCollectionPopup = null;
        var editCollectionPopup = null;
        var collections = [];

        $.getJSON(`${apiBase}/inventory`)
            .done(data => initialize(data))
            .fail((jqXHR, textStatus, errorThrown) => {
                console.error("Failed to fetch inventory:", textStatus, errorThrown);
                DevExpress.ui.notify('Error loading inventory data', 'error', 3000);
            });

        function initialize(data) {

            drawDataGrid();

            collections = data;

            drawCollectionSelectorElement();
            drawNewCollectionPopup();
            drawNewCollectionButton();
            drawEditCollectionButton();
            drawRemoveCollectionButton();
            drawEditCollectionPopup();

            if (collections.length > 0) {
                const collection = collections[0];
                currentCollectionId = collection.Id;
                reloadGrid(collection.Records ?? [], currentCollectionId);
            }
        }

        function drawCollectionSelectorElement() {
            selectorElement.dxSelectBox({
                dataSource: collections,
                displayExpr: 'Name',
                valueExpr: 'Id',
                value: collections.length > 0 ? collections[0].Id : null,
                onValueChanged: e => {
                    currentCollectionId = e.value;
                    const records = collections.find(x => x.Id === currentCollectionId)?.Records || [];
                    reloadGrid(records, currentCollectionId);
                }
            });
        }

        function drawNewCollectionButton() {
            $('#add-collection').dxButton({
                icon: 'plus',
                hint: 'Add Collection',
                stylingMode: 'contained',
                onClick: function () {

                    const newCollectionForm = $('.new-collection-form').dxForm('instance');
                    if (newCollectionForm) {
                        newCollectionForm.clear();

                        const textBox = newCollectionForm.getEditor('Name');
                        if (textBox) textBox.option('disabled', false);
                    }

                    newCollectionPopup.show();
                }
            });
        }

        function drawEditCollectionButton() {
            $('#edit-collection').dxButton({
                icon: 'edit',
                hint: 'Edit Collection',
                stylingMode: 'contained',
                onClick: function () {

                    const editCollectionForm = $('.edit-collection-form').dxForm('instance');
                    if (editCollectionForm) {
                        editCollectionForm.clear();

                        const textBox = editCollectionForm.getEditor('Name');
                        if (textBox) textBox.option('disabled', false);
                    }

                    editCollectionPopup.show();
                }
            });
        }

        function drawRemoveCollectionButton() {
            $('#remove-collection').dxButton({
                icon: 'trash',
                hint: "Remove Collection",
                stylingMode: 'contained',
                onClick: async function () {
                    try {

                        if (!currentCollectionId) return;

                        const currentIndex = collections.findIndex(c => c.Id === currentCollectionId);
                        if (currentIndex < 0) return;

                        const currentName = collections[currentIndex].Name;

                        const dialogResult = await confirmDeleteCollectionAsync(`Are you sure you want to delete the collection "${currentName}"?`, 'Confirm Delete');
                        if (!dialogResult) return;

                        await deleteCollection();
                        handleDeleteCollection(currentIndex);

                    } catch (error) {
                        console.error("Error deleting collection:", error.responseText);
                    }
                }
            });
        }

        function drawNewCollectionPopup() {
            newCollectionPopup = newCollectionPopupElement.dxPopup({
                title: 'Create New Collection',
                width: 400,
                height: 110,
                visible: false,
                dragEnabled: true,
                showCloseButton: true,
                showTitle: true,
                closeOnOutsideClick: true,
                onShown: function () {
                    const input = $('#new-collection-form').find('.dx-textbox input').get(0);
                    if (input) input.focus();
                },
                contentTemplate: function (contentElement) {
                    const formContainer = $('<div class="new-collection-form">').appendTo(contentElement);

                    const formInstance = formContainer.dxForm({
                        formData: { Name: '' },
                        items: [
                            {
                                dataField: 'Name',
                                label: { text: 'Collection Name' },
                                editorType: 'dxTextBox',
                                isRequired: true,
                                editorOptions: {
                                    onKeyDown: async function (e) {
                                        if (e.event.key !== 'Enter' || e.component.option('disabled')) return;
                                        e.component.option('disabled', true);

                                        const collectionName = e.component.option('value')?.trim();

                                        if (!collectionName) {
                                            DevExpress.ui.notify('Please enter a collection name.', 'warning', 2000);
                                            e.component.option('disabled', false);
                                            return;
                                        }

                                        if (collections.some(c => c.Name.toLowerCase() === collectionName.toLowerCase())) {
                                            DevExpress.ui.notify('Collection name already exists.', 'warning', 2000);
                                            e.component.option('disabled', false);
                                            return;
                                        }

                                        const newCollection = {
                                            Id: getUUID(),
                                            Name: collectionName,
                                            Records: []
                                        };

                                        try {

                                            await insertCollection(newCollection);
                                            handleInsertCollection(newCollection);
                                            newCollectionPopup.hide();

                                        } catch (error) {
                                            console.error("Error adding collection: ", error.responseText)
                                        }

                                        e.component.option('disabled', false);
                                    }
                                }
                            },
                        ]
                    }).dxForm('instance');
                }
            }).dxPopup('instance');
        }

        function drawEditCollectionPopup() {
            editCollectionPopup = editCollectionPopupElement.dxPopup({
                title: 'Edit Collection',
                width: 400,
                height: 110,
                visible: false,
                dragEnabled: true,
                showCloseButton: true,
                showTitle: true,
                closeOnOutsideClick: true,
                onShown: function () {
                    const input = $('#edit-collection-form').find('.dx-textbox input').get(0);
                    if (input) input.focus();
                },
                contentTemplate: async function (contentElement) {
                    const formContainer = $('<div class="edit-collection-form">').appendTo(contentElement);

                    const currentCollection = collections.find(c => c.Id === currentCollectionId);

                    if (!currentCollection) {
                        await handleError("No collection is selected for editing", null, null, false);
                        return $('<div>').text('Please select a collection first.').appendTo(contentElement);
                    }

                    const formInstance = formContainer.dxForm({
                        formData: { Name: currentCollection.Name },
                        items: [
                            {
                                dataField: 'Name',
                                label: { text: 'Collection Name' },
                                editorType: 'dxTextBox',
                                isRequired: true,
                                editorOptions: {
                                    onKeyDown: async function (e) {
                                        if (e.event.key !== 'Enter' || e.component.option('disabled')) return;
                                        e.component.option('disabled', true);

                                        const collectionName = e.component.option('value')?.trim();

                                        if (!collectionName) {
                                            DevExpress.ui.notify('Please enter a collection name.', 'warning', 2000);
                                            e.component.option('disabled', false);
                                            return;
                                        }

                                        if (collections.some(c => c.Id !== currentCollection.Id && c.Name.toLowerCase() === collectionName.toLowerCase())) {
                                            DevExpress.ui.notify('Collection name already exists.', 'warning', 2000);
                                            e.component.option('disabled', false);
                                            return;
                                        }

                                        try {
                                            currentCollection.Name = collectionName;
                                            await updateCollection(currentCollection);
                                            handleUpdateCollection(currentCollection);
                                            editCollectionPopup.hide();

                                        } catch (error) {
                                            console.error("Error adding collection: ", error.responseText)
                                        }

                                        e.component.option('disabled', false);
                                    }
                                }
                            },
                        ]
                    }).dxForm('instance');
                }
            }).dxPopup('instance');
        }

        function drawDataGrid() {
            gridElement.dxDataGrid({
                dataSource: [],
                keyExpr: 'Id',
                remoteOperations: false,
                showBorders: true,
                repaintChangesOnly: true,
                columnAutoWidth: true,
                searchPanel: {
                    visible: true,
                    highlightSearchText: true,
                    highlightCaseSensitive: false
                },
                columnChooser: { enabled: true, mode: 'select' },
                editing: {
                    mode: 'form',
                    allowUpdating: true,
                    allowAdding: true,
                    allowDeleting: true,
                    useIcons: true
                },
                columnResizingMode: 'nextColumn',
                allowColumnResizing: true,
                columns: [
                    { dataField: 'Id', caption: 'ID', allowEditing: false, visible: false },
                    { dataField: 'Make', caption: 'Make' },
                    { dataField: 'Model', caption: 'Model' },
                    { dataField: 'Year', caption: 'Year', dataType: 'number' },
                    { dataField: 'Description', caption: 'Description', visible: false },
                    { dataField: 'Notes', caption: 'Notes', visible: false },
                    { dataField: 'Images', caption: 'Images', visible: false, allowSearch: false },
                    {
                        dataField: 'Categories', caption: 'Categories',
                        calculateCellValue: d => d.Categories?.join(', ') || ''
                    },
                    { dataField: 'PurchaseDate', caption: 'Purchase Date', dataType: 'date' },
                    { dataField: 'Price', caption: 'Price', format: 'currency' },
                    { dataField: 'Value', caption: 'Value', format: 'currency' }
                ],
                paging: { pageSize: 10 },
                pager: {
                    visible: true,
                    showPageSizeSelector: true,
                    allowedPageSizes: [10, 20, 50, 100, 'all'],
                    showInfo: true,
                    showNavigationButtons: true
                }
            });
        }

        function setGridDataStore(records, collectionId) {
            return new DevExpress.data.CustomStore({
                key: 'Id',

                load: () => Promise.resolve(records),
                insert: (record) => insertRecord(record),
                update: (key, record) => updateRecord(record),
                remove: (key) => deleteRecord(key)
            });
        }

        function confirmDeleteCollectionAsync(message, title) {
            return new Promise(resolve => {
                DevExpress.ui.dialog.confirm(message, title).done(result => {
                    resolve(result);
                });
            });
        }

        function handleDeleteCollection(currentIndex) {

            collections = collections.filter(c => c.Id !== currentCollectionId);
            const newSelection = collections.length ? collections[0].Id : null;

            const selected = collections.find(x => x.Id === newSelection);
            currentCollectionId = selected?.Id ?? null;

            reloadSelector();

            reloadGrid(selected?.Records ?? [], currentCollectionId);
        }

        function handleInsertCollection(newCollection) {

            collections.push(newCollection);

            currentCollectionId = newCollection.Id;

            reloadSelector();

            reloadGrid([], currentCollectionId);
        }

        function handleUpdateCollection() {
            reloadSelector();
        }

        function reloadSelector() {
            selectorElement.dxSelectBox('instance').option('dataSource', collections);
            selectorElement.dxSelectBox('instance').option('value', currentCollectionId);
        }

        function reloadGrid(records, collectionId) {
            gridElement.dxDataGrid('instance').option('dataSource', setGridDataStore(records, collectionId));
        }

        function insertRecord(record) {
            return $.ajax({
                url: `${apiBase}/inventory/${currentCollectionId}/records/new`,
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(record)
            });
        }

        function updateRecord(record) {
            return $.ajax({
                url: `${apiBase}/inventory/${currentCollectionId}/records/update`,
                method: 'PUT',
                contentType: 'application/json',
                data: JSON.stringify(record)
            });
        }

        function deleteRecord(recordId) {
            return $.ajax({
                url: `${apiBase}/inventory/${currentCollectionId}/records/delete/${recordId}`,
                method: 'DELETE'
            });
        }

        function reportError(details, stackTrace, code) {
            const error = {
                Id: getUUID(),
                Code: code,
                Details: details,
                StackTrace: stackTrace
            };

            return $.ajax({
                url: `${apiBase}/inventory/error`,
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(error)
            });
        }

        function insertCollection(collection) {
            return $.ajax({
                url: `${apiBase}/inventory/collections/new`,
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(collection)
            });
        }

        function updateCollection(collection) {
            return $.ajax({
                url: `${apiBase}/inventory/collections/update`,
                method: 'PUT',
                contentType: 'application/json',
                data: JSON.stringify(collection)
            });
        }

        function deleteCollection() {
            return $.ajax({
                url: `${apiBase}/inventory/collections/delete/${currentCollectionId}`,
                method: 'DELETE',
                contentType: 'application/json'
            });
        }

        async function handleError(details, stackTrace, code, shouldReport) {
            //TODO -- not all errors should be reported. Some should just be displayed to user
            DevExpress.ui.notify(details, 'warning', 2500);
            if (shouldReport) await reportError(details, stackTrace, code);
        }

        function getUUID() {
            return crypto.randomUUID?.() || Date.now().toString();
        }
    </script>
</body>
</html>