<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>My Inventory</title>
    <link rel="stylesheet" href="https://cdn3.devexpress.com/jslib/23.2.5/css/dx.dark.compact.css" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn3.devexpress.com/jslib/23.2.5/js/dx.all.js"></script>
    <style>
        body {
            background: #2d2d2d;
            color: #f0f0f0;
            font-family: Segoe UI, sans-serif;
        }

        #dataset-selector {
            max-width: 260px
        }
    </style>
</head>
<body>
    <div style="padding:20px">
        <div id="dataset-selector" style="margin-bottom:20px"></div>
        <div id="add-collection"></div>
        <div id="remove-collection"></div>
        <div id="inventory-grid"></div>
    </div>

    <script>
        const apiBase = 'http://localhost:5000/api';
        const gridElement = $('#inventory-grid');
        const selectorElement = $('#dataset-selector');
        const addCollectionButton = $('#add-collection');
        const removeCollectionButton = $('#remove-collection');
        var currentCollectionId = "";

        function makeDataStore(records, collectionId) {
            return new DevExpress.data.CustomStore({
                key: 'Id',

                load: () => Promise.resolve(records),
                insert: (record) => insertRecord(record),
                update: (key, record) => updateRecord(record),
                remove: (key) => deleteRecord(key)
            });
        }

        gridElement.dxDataGrid({
            dataSource: [],
            keyExpr: 'Id',
            remoteOperations: false,
            showBorders: true,
            repaintChangesOnly: true,
            columnAutoWidth: true,
            searchPanel: {
                visible: true,
                highlightSearchText: true,
                highlightCaseSensitive: false
            },
            columnChooser: { enabled: true, mode: 'select' },
            editing: {
                mode: 'form',
                allowUpdating: true,
                allowAdding: true,
                allowDeleting: true,
                useIcons: true
            },
            columnResizingMode: 'nextColumn',
            allowColumnResizing: true,
            columns: [
                { dataField: 'Id', caption: 'ID', allowEditing: false, visible: false },
                { dataField: 'Make', caption: 'Make' },
                { dataField: 'Model', caption: 'Model' },
                { dataField: 'Year', caption: 'Year', dataType: 'number' },
                { dataField: 'Description', caption: 'Description', visible: false },
                { dataField: 'Notes', caption: 'Notes', visible: false },
                { dataField: 'Images', caption: 'Images', visible: false, allowSearch: false },
                {
                    dataField: 'Categories', caption: 'Categories',
                    calculateCellValue: d => d.Categories?.join(', ') || ''
                },
                { dataField: 'PurchaseDate', caption: 'Purchase Date', dataType: 'date' },
                { dataField: 'Price', caption: 'Price', format: 'currency' },
                { dataField: 'Value', caption: 'Value', format: 'currency' }
            ],

            paging: { pageSize: 10 },
            pager: {
                visible: true,
                showPageSizeSelector: true,
                allowedPageSizes: [10, 20, 50, 100, 'all'],
                showInfo: true,
                showNavigationButtons: true
            }
        });

        $.getJSON(`${apiBase}/inventory`).done(collections => {

            const selectorData = [
                ...collections.map(c => ({ Id: c.Id, Name: c.Name, Records: c.Records }))
            ];

            selectorElement.dxSelectBox({
                dataSource: selectorData,
                displayExpr: 'Name',
                valueExpr: 'Id',
                value: collections.length > 0 ? collections[0].Id : null,
                onValueChanged: e => {
                    currentCollectionId = e.value;
                    const records = selectorData.find(x => x.Id === currentCollectionId)?.Records || [];
                    gridElement.dxDataGrid('instance').option('dataSource', makeDataStore(records, currentCollectionId));
                }
            });

            addCollectionButton.dxButton({
                text: 'Add Collection',
                icon: 'plus',
                type: 'default',
                stylingMode: 'contained',
                onClick: async function () {
                    try {

                        const newCollection = {
                            Id: crypto.randomUUID?.() || Date.now().toString(),
                            Name: "New Collection",
                            Records: []
                        };

                        await insertCollection(newCollection);
                        handleInsertCollection(newCollection, selectorData, collections);

                    } catch (error) {
                        console.error("Error adding collection:", error.responseText);
                    }
                }
            });

            removeCollectionButton.dxButton({
                text: 'Remove Collection',
                icon: 'trash',
                type: 'danger',
                stylingMode: 'contained',
                onClick: async function () {
                    try {

                        if (!currentCollectionId) return;

                        const currentIndex = selectorData.findIndex(c => c.Id === currentCollectionId);
                        if (currentIndex < 0) return;

                        const currentName = selectorData[currentIndex].Name;

                        const dialogResult = await confirmDeleteCollectionAsync(`Are you sure you want to delete the collection "${currentName}"?`, 'Confirm Delete');
                        if (!dialogResult) return;


                        await deleteCollection(currentCollectionId);
                        handleDeleteCollection(selectorData, currentIndex, collections);

                    } catch (error) {
                        console.error("Error deleting collection:", error.responseText);
                    }
                }
            });

            if (collections.length > 0) {
                const collection = collections[0];
                currentCollectionId = collection.Id;
                gridElement.dxDataGrid('instance').option('dataSource', makeDataStore(collection.Records ?? [], currentCollectionId));
            }
        });

        function confirmDeleteCollectionAsync(message, title) {
            return new Promise(resolve => {
                DevExpress.ui.dialog.confirm(message, title).done(result => {
                    resolve(result);
                });
            });
        }

        function handleDeleteCollection(selectorData, currentIndex, collections) {
            console.log("Collection Deleted");

            selectorData.splice(currentIndex, 1);
            collections = collections.filter(c => c.Id !== currentCollectionId);

            selectorElement.dxSelectBox('instance').option('dataSource', selectorData);

            const newSelection = selectorData.length ? selectorData[0].Id : null;
            selectorElement.dxSelectBox('instance').option('value', newSelection);

            const selected = selectorData.find(x => x.Id === newSelection);
            currentCollectionId = selected?.Id;

            gridElement.dxDataGrid('instance').option('dataSource', makeDataStore(selected?.Records ?? [], currentCollectionId));
        }

        function handleInsertCollection(newCollection, selectorData, collections) {
            console.log("Collection Added");

            collections.push(newCollection);
            selectorData.push(newCollection);

            currentCollectionId = newCollection.Id;

            selectorElement.dxSelectBox('instance').option('dataSource', selectorData);
            selectorElement.dxSelectBox('instance').option('value', currentCollectionId);

            gridElement.dxDataGrid('instance').option('dataSource', makeDataStore([], currentCollectionId));
        }

        function insertRecord(record) {
            return $.ajax({
                url: `${apiBase}/inventory/${currentCollectionId}/records/new`,
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(record)
            });
        }

        function updateRecord(record) {
            return $.ajax({
                url: `${apiBase}/inventory/${currentCollectionId}/records/update`,
                method: 'PUT',
                contentType: 'application/json',
                data: JSON.stringify(record)
            });
        }

        function deleteRecord(recordId) {
            return $.ajax({
                url: `${apiBase}/inventory/${currentCollectionId}/records/delete/${recordId}`,
                method: 'DELETE'
            });
        }

        function insertCollection(collection) {
            return $.ajax({
                url: `${apiBase}/inventory/collections/new`,
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(collection)
            });
        }

        function deleteCollection(collectionId) {
            return $.ajax({
                url: `${apiBase}/inventory/collections/delete/${collectionId}`,
                method: 'DELETE',
                contentType: 'application/json'
            });
        }
    </script>
</body>
</html>