<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>My Inventory</title>
    <link rel="stylesheet" href="https://cdn3.devexpress.com/jslib/23.2.5/css/dx.dark.compact.css" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn3.devexpress.com/jslib/23.2.5/js/dx.all.js"></script>
    <style>
        body {
            background: #2d2d2d;
            color: #f0f0f0;
            font-family: Segoe UI, sans-serif;
        }

        #dataset-selector {
            max-width: 260px
        }
    </style>
</head>
<body>
    <div style="padding:20px">
        <div id="dataset-selector" style="margin-bottom:20px"></div>
        <div id="add-collection"></div>
        <div id="remove-collection"></div>
        <div id="inventory-grid"></div>
    </div>

    <script>
        const apiBase = 'http://localhost:5000/api';
        const gridElement = $('#inventory-grid');
        const selectorElement = $('#dataset-selector');
        const addCollectionButton = $('#add-collection');
        const removeCollectionButton = $('#remove-collection');

        function makeDataStore(records, collectionId) {
            return new DevExpress.data.CustomStore({
                key: 'Id',

                load: () => Promise.resolve(records),

                insert: (values) => $.ajax({
                    url: `${apiBase}/inventory/${collectionId}/records`,
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(values)
                }),

                update: (key, values) => $.ajax({
                    url: `${apiBase}/inventory/${collectionId}/records/${key}`,
                    method: 'PUT',
                    contentType: 'application/json',
                    data: JSON.stringify(values)
                }),

                remove: (key) => $.ajax({
                    url: `${apiBase}/inventory/${collectionId}/records/${key}`,
                    method: 'DELETE'
                })
            });
        }

        gridElement.dxDataGrid({
            dataSource: [],
            keyExpr: 'Id',
            remoteOperations: false,
            showBorders: true,
            repaintChangesOnly: true,
            columnAutoWidth: true,
            searchPanel: {
                visible: true,
                highlightSearchText: true,
                highlightCaseSensitive: false
            },
            columnChooser: { enabled: true, mode: 'select' },
            editing: {
                mode: 'form',
                allowUpdating: true,
                allowAdding: true,
                allowDeleting: true,
                useIcons: true
            },
            columnResizingMode: 'nextColumn',
            allowColumnResizing: true,
            columns: [
                { dataField: 'Id', caption: 'ID', allowEditing: false, visible: false },
                { dataField: 'Make', caption: 'Make' },
                { dataField: 'Model', caption: 'Model' },
                { dataField: 'Year', caption: 'Year', dataType: 'number' },
                { dataField: 'Description', caption: 'Description', visible: false },
                { dataField: 'Notes', caption: 'Notes', visible: false },
                { dataField: 'Images', caption: 'Images', visible: false, allowSearch: false },
                {
                    dataField: 'Categories', caption: 'Categories',
                    calculateCellValue: d => d.Categories?.join(', ') || ''
                },
                { dataField: 'PurchaseDate', caption: 'Purchase Date', dataType: 'date' },
                { dataField: 'Price', caption: 'Price', format: 'currency' },
                { dataField: 'Value', caption: 'Value', format: 'currency' }
            ],

            paging: { pageSize: 10 },
            pager: {
                visible: true,
                showPageSizeSelector: true,
                allowedPageSizes: [10, 20, 50, 100, 'all'],
                showInfo: true,
                showNavigationButtons: true
            }
        });

        $.getJSON(`${apiBase}/inventory`).done(collections => {

            const selectorData = [
                ...collections.map(c => ({ Id: c.Id, Name: c.Name, Records: c.Records }))
            ];

            selectorElement.dxSelectBox({
                dataSource: selectorData,
                displayExpr: 'Name',
                valueExpr: 'Id',
                value: collections.length > 0 ? collections[0].Id : null,
                onCustomItemCreating: function (e) {

                },
                onValueChanged: e => {
                    const records = selectorData.find(x => x.Id === e.value)?.Records || [];
                    gridElement.dxDataGrid('instance').option('dataSource', makeDataStore(records, e.value));
                }
            });

            addCollectionButton.dxButton({
                text: 'Add Collection',
                icon: 'plus',
                type: 'default',
                stylingMode: 'contained',
                onClick: function () {
                    //TODO
                    //DevExpress.ui.dialog('Enter new collection name:', 'Add Collection')
                    //    .done(function (newName) {
                    //        const name = newName?.trim();
                    //        if (!name) return;

                    //        const newCollection = {
                    //            Id: crypto.randomUUID?.() || Date.now().toString(),
                    //            Name: name,
                    //            Records: []
                    //        };

                    //        collections.push(newCollection);
                    //        selectorData.push(newCollection);

                    //        selectorElement.dxSelectBox('instance').option('dataSource', selectorData);
                    //        selectorElement.dxSelectBox('instance').option('value', newCollection.Id);

                    //        gridElement.dxDataGrid('instance').option('dataSource', makeDataStore([], newCollection.Id));
                    //    });
                }
            });

            removeCollectionButton.dxButton({
                text: 'Remove Collection',
                icon: 'trash',
                type: 'danger',
                stylingMode: 'contained',
                onClick: function () {
                    const currentId = selectorElement.dxSelectBox('instance').option('value');
                    if (!currentId) return;

                    const currentIndex = selectorData.findIndex(c => c.Id === currentId);
                    if (currentIndex < 0) return;

                    const currentName = selectorData[currentIndex].Name;

                    DevExpress.ui.dialog.confirm(`Are you sure you want to delete the collection "${currentName}"?`, 'Confirm Delete')
                        .done(function (result) {
                            if (!result) return;

                            // Remove from both arrays
                            selectorData.splice(currentIndex, 1);
                            collections = collections.filter(c => c.Id !== currentId);

                            // Update SelectBox
                            selectorElement.dxSelectBox('instance').option('dataSource', selectorData);

                            const newSelection = selectorData.length ? selectorData[0].Id : null;
                            selectorElement.dxSelectBox('instance').option('value', newSelection);

                            const selected = selectorData.find(x => x.Id === newSelection);
                            gridElement.dxDataGrid('instance').option('dataSource', makeDataStore(selected?.Records ?? [], selected?.Id));
                        });
                }
            });

            if (collections.length > 0) {
                const collection = collections[0];
                gridElement.dxDataGrid('instance').option('dataSource', makeDataStore(collection.Records ?? [], collection.Id));
            }
        });
    </script>
</body>
</html>