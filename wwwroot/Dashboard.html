<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>My Inventory</title>
    <link rel="stylesheet" href="https://cdn3.devexpress.com/jslib/23.2.5/css/dx.dark.compact.css" />
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn3.devexpress.com/jslib/23.2.5/js/dx.all.js"></script>
    <style>
        body {
            background: #2d2d2d;
            color: #f0f0f0;
            font-family: Segoe UI, sans-serif;
        }

        #dataset-selector {
            max-width: 260px
        }

        #selector-container {
            display: flex;
        }

        #dataset-selector {
            margin-right: 10px;
        }

        #add-collection {
            margin-right: 10px;
        }

        #edit-collection {
            margin-right: 10px;
        }

        #remove-collection {
        }

        #collection-value {
            margin: 10px;
        }

        #collection-details {
            margin: 10px;
        }

        .master-detail-container {
            padding: 10px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .image-gallery-wrapper {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 10px;
        }

        .image-gallery-controls {
            display: flex;
        }

        .add-image-button {
            margin-right: 10px;
        }

        .remove-image-button {
            margin-right: 10px;
        }
    </style>
</head>
<body>
    <div style="padding:20px">
        <div id="selector-container">
            <div id="dataset-selector"></div>
            <div id="add-collection"></div>
            <div id="edit-collection"></div>
            <div id="remove-collection"></div>
        </div>
        <div id="collection-value"></div>
        <div id="collection-details"></div>
        <div id="inventory-grid"></div>
        <div id="new-collection-popup"></div>
        <div id="edit-collection-popup"></div>
    </div>

    <script>
        //Web view 2 will set set window.localHost prior to load
        function getApiBase() {
            return `http://localhost:${window.localHost}/api`;
        }

        const gridElement = $('#inventory-grid');
        const selectorElement = $('#dataset-selector');
        const detailsElement = $('#collection-details');
        const valueElement = $('#collection-value');
        const newCollectionPopupElement = $('#new-collection-popup');
        const editCollectionPopupElement = $('#edit-collection-popup');

        let detailsAreUpdating = false;

        var currentCollectionId = "";
        var newCollectionPopup = null;
        var editCollectionPopup = null;
        var collections = [];
        var masterCategories = [];

        $.getJSON(`${getApiBase()}/inventory`)
            .done(data => initialize(data))
            .fail((jqXHR, textStatus, errorThrown) => {
                console.error("Failed to fetch inventory:", textStatus, errorThrown);
                DevExpress.ui.notify('Error loading inventory data', 'error', 3000);
            });

        function initialize(data) {

            drawDataGrid();

            collections = data;
            masterCategories = getUniqueCategories();

            drawCollectionSelectorElement();
            drawCollectionDetailsElement();
            drawCollectionValueElement();
            drawNewCollectionPopup();
            drawNewCollectionButton();
            drawEditCollectionButton();
            drawRemoveCollectionButton();
            drawEditCollectionPopup();

            if (collections.length > 0) {
                const collection = collections[0];
                currentCollectionId = collection.Id;
                reloadGrid(collection.Records ?? [], currentCollectionId);
            }
        }

        function drawCollectionSelectorElement() {
            selectorElement.dxSelectBox({
                dataSource: collections,
                displayExpr: 'Name',
                valueExpr: 'Id',
                value: collections.length > 0 ? collections[0].Id : null,
                onValueChanged: e => {
                    currentCollectionId = e.value;
                    const currentCollection = collections.find(x => x.Id === currentCollectionId);

                    const records = currentCollection?.Records || [];
                    reloadGrid(records, currentCollectionId);

                    detailsAreUpdating = true;
                    const details = collections.find(c => c.Id === currentCollectionId)?.Details;
                    reloadDetails(details);
                    detailsAreUpdating = false;

                    reloadValue(currentCollection?.Value);
                }
            });
        }

        function drawCollectionDetailsElement() {
            detailsElement.dxTextArea({
                label: "Collection Notes",
                labelMode: "floating",
                value: collections.length > 0 ? collections[0].Details : null,
                height: 90,
                inputAttr: { 'aria-label': 'Notes' },
                onValueChanged: async function (e) {

                    if (detailsAreUpdating) return;

                    let collection = collections.find(c => c.Id === currentCollectionId);
                    if (collection) {
                        collection.Details = e.value;
                        await updateCollection(collection);
                    }
                }
            });
        }

        function drawCollectionValueElement() {
            valueElement.dxNumberBox({
                label: "Calculated Value",
                value: collections.length > 0 ? collections[0].Value : null,
                format: {
                    type: "currency",
                    precision: 2
                },
                readOnly: true
            });
        }

        function drawNewCollectionButton() {
            $('#add-collection').dxButton({
                icon: 'plus',
                hint: 'Add Collection',
                stylingMode: 'contained',
                onClick: function () {

                    const newCollectionForm = $('.new-collection-form').dxForm('instance');
                    if (newCollectionForm) {
                        newCollectionForm.clear();

                        const textBox = newCollectionForm.getEditor('Name');
                        if (textBox) textBox.option('disabled', false);
                    }

                    newCollectionPopup.show();
                }
            });
        }

        function drawEditCollectionButton() {
            $('#edit-collection').dxButton({
                icon: 'edit',
                hint: 'Edit Collection',
                stylingMode: 'contained',
                onClick: function () {

                    const editCollectionForm = $('.edit-collection-form').dxForm('instance');
                    if (editCollectionForm) {
                        editCollectionForm.clear();

                        const textBox = editCollectionForm.getEditor('Name');
                        if (textBox) textBox.option('disabled', false);
                    }

                    editCollectionPopup.show();
                }
            });
        }

        function drawRemoveCollectionButton() {
            $('#remove-collection').dxButton({
                icon: 'trash',
                hint: "Remove Collection",
                stylingMode: 'contained',
                onClick: async function () {
                    try {

                        if (!currentCollectionId) return;

                        const currentIndex = collections.findIndex(c => c.Id === currentCollectionId);
                        if (currentIndex < 0) return;

                        const currentName = collections[currentIndex].Name;

                        const dialogResult = await confirmAsync(`Are you sure you want to delete the collection "${currentName}"?`, 'Confirm Delete');
                        if (!dialogResult) return;

                        await deleteCollection();
                        handleDeleteCollection(currentIndex);

                    } catch (error) {
                        console.error("Error deleting collection:", error.responseText);
                    }
                }
            });
        }

        function drawNewCollectionPopup() {
            newCollectionPopup = newCollectionPopupElement.dxPopup({
                title: 'Create New Collection',
                width: 400,
                height: 110,
                visible: false,
                dragEnabled: true,
                showCloseButton: true,
                showTitle: true,
                hideOnOutsideClick: true,
                onShown: function () {
                    const input = $('#new-collection-form').find('.dx-textbox input').get(0);
                    if (input) input.focus();
                },
                contentTemplate: function (contentElement) {
                    const formContainer = $('<div class="new-collection-form">').appendTo(contentElement);

                    const formInstance = formContainer.dxForm({
                        formData: { Name: '' },
                        items: [
                            {
                                dataField: 'Name',
                                label: { text: 'Collection Name' },
                                editorType: 'dxTextBox',
                                isRequired: true,
                                editorOptions: {
                                    onKeyDown: async function (e) {
                                        if (e.event.key !== 'Enter' || e.component.option('disabled')) return;
                                        e.component.option('disabled', true);

                                        const collectionName = e.component.option('value')?.trim();

                                        if (!collectionName) {
                                            DevExpress.ui.notify('Please enter a collection name.', 'warning', 2000);
                                            e.component.option('disabled', false);
                                            return;
                                        }

                                        if (collections.some(c => c.Name.toLowerCase() === collectionName.toLowerCase())) {
                                            DevExpress.ui.notify('Collection name already exists.', 'warning', 2000);
                                            e.component.option('disabled', false);
                                            return;
                                        }

                                        const newCollection = {
                                            Id: getUUID(),
                                            Name: collectionName,
                                            Records: []
                                        };

                                        try {

                                            await insertCollection(newCollection);
                                            handleInsertCollection(newCollection);
                                            newCollectionPopup.hide();

                                        } catch (error) {
                                            console.error("Error adding collection: ", error.responseText)
                                        }

                                        e.component.option('disabled', false);
                                    }
                                }
                            },
                        ]
                    }).dxForm('instance');
                }
            }).dxPopup('instance');
        }

        function drawEditCollectionPopup() {
            editCollectionPopup = editCollectionPopupElement.dxPopup({
                title: 'Edit Collection',
                width: 400,
                height: 110,
                visible: false,
                dragEnabled: true,
                showCloseButton: true,
                showTitle: true,
                hideOnOutsideClick: true,
                onShown: function () {
                    const input = $('#edit-collection-form').find('.dx-textbox input').get(0);
                    if (input) input.focus();
                },
                contentTemplate: async function (contentElement) {
                    const formContainer = $('<div class="edit-collection-form">').appendTo(contentElement);

                    const currentCollection = collections.find(c => c.Id === currentCollectionId);

                    if (!currentCollection) {
                        await handleError("No collection is selected for editing", null, null, false);
                        return $('<div>').text('Please select a collection first.').appendTo(contentElement);
                    }

                    const formInstance = formContainer.dxForm({
                        formData: { Name: currentCollection.Name },
                        items: [
                            {
                                dataField: 'Name',
                                label: { text: 'Collection Name' },
                                editorType: 'dxTextBox',
                                isRequired: true,
                                editorOptions: {
                                    onKeyDown: async function (e) {
                                        if (e.event.key !== 'Enter' || e.component.option('disabled')) return;
                                        e.component.option('disabled', true);

                                        const collectionName = e.component.option('value')?.trim();

                                        if (!collectionName) {
                                            DevExpress.ui.notify('Please enter a collection name.', 'warning', 2000);
                                            e.component.option('disabled', false);
                                            return;
                                        }

                                        if (collections.some(c => c.Id !== currentCollection.Id && c.Name.toLowerCase() === collectionName.toLowerCase())) {
                                            DevExpress.ui.notify('Collection name already exists.', 'warning', 2000);
                                            e.component.option('disabled', false);
                                            return;
                                        }

                                        try {
                                            currentCollection.Name = collectionName;
                                            await updateCollection(currentCollection);
                                            handleUpdateCollection(currentCollection);
                                            editCollectionPopup.hide();

                                        } catch (error) {
                                            console.error("Error adding collection: ", error.responseText)
                                        }

                                        e.component.option('disabled', false);
                                    }
                                }
                            },
                        ]
                    }).dxForm('instance');
                }
            }).dxPopup('instance');
        }

        function drawDataGrid() {
            gridElement.dxDataGrid({
                dataSource: [],
                showBorders: true,
                repaintChangesOnly: true,
                columnAutoWidth: true,
                searchPanel: {
                    visible: true,
                    highlightSearchText: true,
                    highlightCaseSensitive: false
                },
                filterRow: { visible: true },
                headerFilter: { visible: true },
                columnChooser: { enabled: true, mode: 'select' },
                editing: {
                    mode: 'form',
                    allowUpdating: true,
                    allowAdding: true,
                    allowDeleting: true,
                    useIcons: true
                },
                columnResizingMode: 'nextColumn',
                allowColumnResizing: true,
                columns: [
                    { dataField: 'Id', allowEditing: false, visible: false },
                    { dataField: 'Notes', caption: 'Notes', visible: false },
                    { dataField: 'Make' },
                    { dataField: 'Model' },
                    { dataField: 'Year', dataType: 'number' },
                    { dataField: 'Description', visible: false },
                    {
                        dataField: 'Categories',
                        editorType: 'dxTagBox',
                        editorOptions: getCategoriesEditorOptions(),
                        allowHeaderFiltering: false,
                        cellTemplate: function (container, options) {
                            const categories = Array.isArray(options.value) ? options.value.join(', ') : '';
                            container.text(categories);
                        }
                    },
                    { dataField: 'PurchaseDate', caption: 'Purchase Date', dataType: 'date' },
                    {
                        dataField: 'Price',
                        format: 'currency',
                        editorType: 'dxNumberBox',
                        format: {
                            type: "currency",
                            precision: 2
                        }
                    },
                    {
                        dataField: 'Value',
                        format: 'currency',
                        editorType: 'dxNumberBox',
                        format: {
                            type: "currency",
                            precision: 2
                        }
                    },
                ],
                paging: { pageSize: 10 },
                pager: {
                    visible: true,
                    showPageSizeSelector: true,
                    allowedPageSizes: [10, 20, 50, 100, 'all'],
                    showInfo: true,
                    showNavigationButtons: true
                },
                masterDetail: {
                    enabled: true,
                    template: drawGridMasterDetail
                },
                onEditorPreparing: function (e) {
                    if (e.parentType === "dataRow") {
                        if (e.dataField === "Price" || e.dataField === "Value") {
                            e.editorOptions.onInput = function (event) {
                                const input = event.event?.target;
                                if (input) {
                                    input.value = input.value.replace(/,/g, '');
                                }
                            };
                        }
                    }

                    if (e.parentType === "filterRow" && e.dataField === "Categories") {
                        e.editorOptions = {
                            items: masterCategories,
                            searchEnabled: true,
                            placeholder: "Select a category...",
                            onValueChanged: function (args) {
                                const selectedValues = args.value;
                                const gridInstance = gridElement.dxDataGrid("instance");

                                if (!selectedValues || selectedValues.length === 0) {
                                    gridInstance.clearFilter();
                                    return;
                                }

                                gridInstance.filter(function (rowData) {
                                    if (!Array.isArray(rowData.Categories)) return false;
                                    return selectedValues.some(v => rowData.Categories.includes(v));
                                });
                            }
                        };
                    }
                }
            });
        }

        function drawGridMasterDetail(container, options) {
            const item = options.data;
            const notes = item.Notes || "";
            let images = item.Images || [];

            const galleryUrls = images.map(path =>
                `local-images?path=${encodeURIComponent(path)}`
            );

            //Container
            const masterContainer = $('<div>').addClass('master-detail-container').appendTo(container);

            //Notes
            $('<div>')
                .dxTextArea({
                    label: "Record Notes",
                    labelMode: "floating",
                    value: notes,
                    height: 90,
                    inputAttr: { 'aria-label': 'Details' },
                    onValueChanged: function (e) {
                        item.Notes = e.value;
                        updateRecord(item);
                    }
                })
                .appendTo(masterContainer);

            //Gallery container
            const galleryWrapper = $('<div>').addClass('image-gallery-wrapper').appendTo(masterContainer);
            const galleryElement = $('<div>').appendTo(galleryWrapper);
            const buttonsContainer = $('<div>').addClass('image-gallery-controls').appendTo(galleryWrapper);
            const addButtonContainer = $('<div>').addClass('add-image-button').appendTo(buttonsContainer);
            const deleteButtonContainer = $('<div>').addClass('remove-image-button').appendTo(buttonsContainer);
            const openDirectoryContainer = $('<div>').addClass('show-directory-button').appendTo(buttonsContainer);

            //Gallery
            const galleryInstance = galleryElement.dxGallery({
                dataSource: galleryUrls,
                height: 250,
                loop: false,
                showNavButtons: true,
                selectedIndex: 0,
                itemTemplate: function (data, index, element) {
                    $('<img>').attr('src', data).css({
                        width: '100%',
                        height: '100%',
                        objectFit: 'contain',
                        borderRadius: '4px',
                        cursor: 'pointer'
                    }).appendTo(element);
                }
            }).dxGallery('instance');

            //Add image
            addButtonContainer.dxButton({
                icon: 'add',
                hint: 'Add Image',
                onClick: function () {
                    getImage(item)
                        .done(result => {
                            if (result?.Path) {
                                item.Images.push(result?.Path);

                                const galleryUrls = item.Images.map(p =>
                                    `local-images?path=${encodeURIComponent(p)}`
                                );

                                //Update control data source
                                galleryInstance.option('dataSource', galleryUrls);

                                //Set new control index
                                galleryInstance.option('selectedIndex', galleryUrls.length - 1);
                            }
                            else DevExpress.ui.notify("No file selected", "info", 2000);
                        })
                        .fail(() => {
                            DevExpress.ui.notify("Failed to get new image path", "error", 2000);
                        });
                }
            });

            //Delete image
            deleteButtonContainer.dxButton({
                icon: 'trash',
                hint: 'Remove Image',
                onClick: async function () {

                    const currentIndex = galleryInstance.option('selectedIndex');
                    if (images.length === 0) return;

                    const dialogResult = await confirmAsync("Are you sure you want to delete this image?", "Confirm Delete");
                    if (!dialogResult) return;

                    let tempImages = [...images];
                    tempImages.splice(currentIndex, 1);

                    item.Images = tempImages;

                    updateRecord(item)
                        .done(result => {
                            images = tempImages;

                            const galleryUrls = images.map(path =>
                                `local-images?path=${encodeURIComponent(path)}`
                            );

                            //Update control data source
                            galleryInstance.option('dataSource', galleryUrls || []);

                            //Set new control index
                            const newIndex = Math.min(currentIndex, galleryUrls.length - 1);
                            if (newIndex >= 0) galleryInstance.option('selectedIndex', newIndex);
                        });
                }
            });

            //Show directory
            openDirectoryContainer.dxButton({
                icon: 'folder',
                hint: 'Open Folder',
                onClick: function () {
                    const selectedIndex = galleryInstance.option('selectedIndex');
                    const selectedUrl = galleryInstance.option('dataSource')[selectedIndex];

                    if (!selectedUrl) {
                        DevExpress.ui.notify("No image selected.", "warning", 2000);
                        return;
                    }

                    const url = new URL(selectedUrl, window.location.origin);
                    const filePath = decodeURIComponent(url.searchParams.get('path'));

                    if (filePath) {
                        openFile(filePath)
                            .fail(() => DevExpress.ui.notify("Failed to open file", "error", 2000));
                    } else {
                        DevExpress.ui.notify("Invalid file path.", "error", 2000);
                    }
                }
            });
        }

        function getCategoriesEditorOptions() {
            return {
                items: masterCategories,
                acceptCustomValue: true
            };
        }

        function getGridDataStore(records, collectionId) {
            return new DevExpress.data.CustomStore({
                key: 'Id',

                load: () => Promise.resolve(records),
                insert: (record) => {
                    return insertRecord(record).done(result => {
                        records.push(result);

                        //Update Value
                        reloadValue();
                    });
                },
                update: (key, values) => {
                    let record = records.find(r => r.Id === key);
                    if (!record) return Promise.reject("Record not found.");

                    Object.keys(values).forEach(valueKey => {
                        record[valueKey] = values[valueKey];
                    });

                    return updateRecord(record).done(result => {
                        const index = records.findIndex(r => r.Id === key);
                        records[index] = result;

                        //Add any new categories
                        result?.Categories?.forEach(c => {
                            if (!masterCategories.includes(c)) masterCategories.push(c);
                        });

                        //Ensures new categories are visible in the Categories column filter
                        gridElement.dxDataGrid("instance").repaint();

                        //Update Value
                        reloadValue();

                    }).fail(error => console.error(error));
                },
                remove: (key) => {
                    const index = records.findIndex(r => r.Id === key);
                    if (index === -1) return Promise.reject("Record not found.");

                    records.splice(index, 1);

                    return deleteRecord(key).done(result => {
                        //Update Value
                        reloadValue();
                    });
                }
            });
        }

        function getUniqueCategories() {
            const allRecords = collections.flatMap(c => c.Records);
            const allCategories = allRecords.flatMap(r => Array.isArray(r.Categories) ? r.Categories : []);
            return [...new Set(allCategories)].sort((a, b) => a.localeCompare(b));
        }

        function confirmAsync(message, title) {
            return new Promise(resolve => {
                DevExpress.ui.dialog.confirm(message, title).done(result => {
                    resolve(result);
                });
            });
        }

        function handleDeleteCollection(currentIndex) {

            collections = collections.filter(c => c.Id !== currentCollectionId);
            const newSelection = collections.length ? collections[0].Id : null;

            const selected = collections.find(x => x.Id === newSelection);
            currentCollectionId = selected?.Id ?? null;

            reloadSelector();

            reloadGrid(selected?.Records ?? [], currentCollectionId);
        }

        function handleInsertCollection(newCollection) {

            collections.push(newCollection);

            currentCollectionId = newCollection.Id;

            reloadSelector();

            reloadGrid([], currentCollectionId);
        }

        function handleUpdateCollection() {
            reloadSelector();
        }

        function reloadSelector() {
            selectorElement.dxSelectBox('instance').option('dataSource', collections);
            selectorElement.dxSelectBox('instance').option('value', currentCollectionId);

            const collection = collections.find(c => c.Id === currentCollectionId);

            reloadDetails(collection?.Details ?? "");
            reloadValue(collection?.Value);
        }

        function reloadDetails(details) {
            const detailsArea = detailsElement.dxTextArea('instance');
            detailsArea.option('value', details);

            const readOnly = collections.length === 0;
            detailsArea.option("readOnly", readOnly);
        }

        function reloadValue(collectionValue) {
            const valueNumberBox = valueElement.dxNumberBox('instance');
            if (collectionValue) {
                valueNumberBox.option('value', collectionValue);
                return;
            }

            getCollectionValue()
                .done(result => {
                    valueNumberBox.option('value', result.Value);
                })
                .fail(error => {
                    console.error(error);
                });
        }

        function reloadGrid(records, collectionId) {
            const grid = gridElement.dxDataGrid('instance');
            grid.option('dataSource', getGridDataStore(records, collectionId));
            grid.columnOption("Categories", {
                editorOptions: getCategoriesEditorOptions()
            });
        }

        function insertRecord(record) {
            return $.ajax({
                url: `${getApiBase()}/inventory/${currentCollectionId}/records/new`,
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(record)
            });
        }

        function updateRecord(record) {
            return $.ajax({
                url: `${getApiBase()}/inventory/${currentCollectionId}/records/update`,
                method: 'PUT',
                contentType: 'application/json',
                data: JSON.stringify(record)
            });
        }

        function deleteRecord(recordId) {
            return $.ajax({
                url: `${getApiBase()}/inventory/${currentCollectionId}/records/delete/${recordId}`,
                method: 'DELETE'
            });
        }

        function getImage(record) {
            return $.ajax({
                url: `${getApiBase()}/inventory/image/${currentCollectionId}`,
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(record)
            });
        }

        function openFile(path) {
            return $.ajax({
                url: `${getApiBase()}/inventory/files/open`,
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    Path: path
                })
            });
        }

        function reportError(details, stackTrace, code) {
            const error = {
                Id: getUUID(),
                Code: code,
                Details: details,
                StackTrace: stackTrace
            };

            return $.ajax({
                url: `${getApiBase()}/inventory/error`,
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(error)
            });
        }

        function insertCollection(collection) {
            return $.ajax({
                url: `${getApiBase()}/inventory/collections/new`,
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(collection)
            });
        }

        function updateCollection(collection) {
            return $.ajax({
                url: `${getApiBase()}/inventory/collections/update`,
                method: 'PUT',
                contentType: 'application/json',
                data: JSON.stringify(collection)
            });
        }

        function getCollectionValue() {
            return $.ajax({
                url: `${getApiBase()}/inventory/${currentCollectionId}/value`,
                method: 'GET',
            });
        }

        function deleteCollection() {
            return $.ajax({
                url: `${getApiBase()}/inventory/collections/delete/${currentCollectionId}`,
                method: 'DELETE',
                contentType: 'application/json'
            });
        }

        async function handleError(details, stackTrace, code, shouldReport) {
            //TODO -- not all errors should be reported. Some should just be displayed to user
            DevExpress.ui.notify(details, 'warning', 2500);
            if (shouldReport) await reportError(details, stackTrace, code);
        }

        function getUUID() {
            return crypto.randomUUID?.() || Date.now().toString();
        }
    </script>
</body>
</html>